<!DOCTYPE html>
<html>
<head>
  <title>Jukebox Yolande : Pilou pilou</title>
</head>
<body>
  <div id="content">
    <h1><img src="../yolande.png" height="80px">Pilou pilou</h1>

    <div id="controls">
      <button onclick="stop()">‚ñ†</button>
      <button onclick="skipBackward()">‚èÆ</button>
      <button id="playButton" onclick="playPause()">‚ñ∂</button>
      <button onclick="skipForward()">‚è≠</button>

      <span id="speedControls">
        <span class="emoji">üê¢</span>
        <input type="range" id="speedInput" name="speed" min="0.5" max="1.5" step="0.1" value="1" onchange="setSpeed(this.value)">
        <span class="emoji">üêá</span>
      </span>
    </div>

    <div class="track" id="mestre">
      <div class="avatar">
        <img src="../mestre.png" alt="mestre" description="mestre" onclick="toggleMute('mestre')" width="80px" height="80px">
      </div>
      <div class="surfer" id="mestre-surfer">
      </div>
    </div>

    <div class="track" id="tamborim">
      <div class="avatar">
        <img src="../tamborim.png" alt="tamborim" description="tamborim" onclick="toggleMute('tamborim')" width="80px" height="80px">
      </div>
      <div class="surfer" id="tamborim-surfer">
      </div>
    </div>

    <div class="track" id="caisse">
      <div class="avatar">
        <img src="../caisse.png" alt="caisse" description="caisse" onclick="toggleMute('caisse')" width="80px" height="80px">
      </div>
      <div class="surfer" id="caisse-surfer">
      </div>
    </div>

    <div class="track" id="repique">
      <div class="avatar">
        <img src="../repique.png" alt="repique" description="repique" onclick="toggleMute('repique')" width="80px" height="80px">
      </div>
      <div class="surfer" id="repique-surfer">
      </div>
    </div>

    <div class="track" id="surdo1">
      <div class="avatar">
        <img src="../surdo1.png" alt="surdo1" description="surdo1" onclick="toggleMute('surdo1')" width="80px" height="80px">
      </div>
      <div class="surfer" id="surdo1-surfer">
      </div>
    </div>

    <div class="track" id="surdo2">
      <div class="avatar">
        <img src="../surdo2.png" alt="surdo2" description="surdo2" onclick="toggleMute('surdo2')" width="80px" height="80px">
      </div>
      <div class="surfer" id="surdo2-surfer">
      </div>
    </div>

    <div class="track" id="surdo3">
      <div class="avatar">
        <img src="../surdo3.png" alt="surdo3" description="surdo3" onclick="toggleMute('surdo3')" width="80px" height="80px">
      </div>
      <div class="surfer" id="surdo3-surfer">
      </div>
    </div>

  </div>

  <style type="text/css">
    body {
      background: #D23789;
      background-image: url("../zebra.svg");
      background-size: cover;
    }
    #content {
      width: 60%;
      margin-left: auto;
      margin-right: auto;
      background: white;
      padding: 20px;
    }
    h1 {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #controls {
      display: flex;
      justify-content: center;
    }
    #speedControls {
      margin-left: 40px;
    }
    .emoji {
      font-size: 30px;
    }
    .avatar {
      display: inline-block;
      vertical-align: middle;
    }
    .muted {
      filter: opacity(50%);
    }
    .surfer {
      display: inline-block;
      vertical-align: middle;
      width:90%;
    }
  </style>
  <script src="../wavesurfer.js"></script>
  <script type="text/javascript">
  let playing = false
  let speedInput = document.getElementById("speedInput")
  let instruments = document.getElementsByClassName("track")
  const surfers = new Map()

  // init waveforms
  for (let i = 0; i < instruments.length; i++) {
    let instrument = instruments[i].id
    let wavesurfer = WaveSurfer.create(
    {
      container: '#'+instrument+"-surfer",
      height: 80,
      waveColor: 'purple',
      progressColor: 'fuchsia',
      responsive: true,
      skipLength: 0.5
    });
    wavesurfer.load(instrument+'.mp3');
    wavesurfer.on('seek', function (progress) { seekTo(progress) })
    surfers.set(instrument, wavesurfer)
  }

  function play() {
    surfers.forEach(function (surfer, instrument) { surfer.play() })
    document.getElementById("playButton").innerHTML = "‚è∏"
    playing = true
  }

  function pause() {
    surfers.forEach( function(surfer) { surfer.pause() })
    document.getElementById("playButton").innerHTML = "‚ñ∂"
    playing = false
  }

  function playPause() {
    if( !playing ) {
      play()
    }
    else {
      pause()
    }
  }

  function seekTo(progress) {
    surfers.forEach(function(surfer) {
      let currentProgress = surfer.getCurrentTime()/surfer.getDuration()
      if(Math.abs(currentProgress-progress) > 0.01) { // avoid recursive events
        surfer.seekTo(progress)
      }
    })
  }

  function stop() {
    pause()
    seekTo(0)
  }

  function skipBackward() {
    surfers.forEach(function(surfer){surfer.skipBackward()})
  }

  function skipForward() {
    surfers.forEach(function(surfer){surfer.skipForward()})
  }

  function setSpeed(speed) {
    console.log(speed)
    surfers.forEach(function(surfer){surfer.setPlaybackRate(speed)})
  }

  function accelerate() {
    let speed = Number(speedInput.value)
    speedInput.value = speed + 0.1
    speedInput.dispatchEvent(new Event('change'))
  }

  function slowdown() {
    let speed = Number(speedInput.value)
    speedInput.value = speed - 0.1
    speedInput.dispatchEvent(new Event('change'))
  }

  function toggleMute(instrument) {
    let surfer = surfers.get(instrument)
    surfer.toggleMute()
    if(surfer.getMute()) {
      document.getElementById(instrument).classList.add("muted")
    } else {
      document.getElementById(instrument).classList.remove("muted")
    }
  }

  function handleKeypress(e) {
    switch(e.which) {
      case 32: // space
        playPause()
        e.preventDefault()
        break
      case 39: // right arrow
        skipForward()
        e.preventDefault()
        break
      case 37: // left arrow
        skipBackward()
        e.preventDefault()
        break
      case 38: // up arrow
        accelerate()
        e.preventDefault()
        break
      case 40: // down arrow
        slowdown()
        e.preventDefault()
        break
    }
  }

  document.addEventListener("keydown", handleKeypress);

  </script>
</body>
</html>