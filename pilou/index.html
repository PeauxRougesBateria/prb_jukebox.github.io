<!DOCTYPE html>
<html>
<head>
  <title>Jukebox Yolande</title>
</head>
<body>
  <h1>
    Jukebox Yolande
  </h1>
  <h2>Pilou pilou</h2>
  
  <button onclick="stop()">Stop</button>
  <button onclick="skipBackward()"><<</button>
  <button id="playButton" onclick="playPause()">Play</button>
  <button onclick="skipForward()">>></button>

  <label for="speed">Speed :</label>
  <input type="range" id="speedInput" name="speed" min="0.5" max="1.5" step="0.1" value="1" onchange="setSpeed(this.value)">

  <div id="mestre" class="track">
    <input type="checkbox" id="toggle-mestre" checked>
    <label for="toggle-mestre">Mestre</label>
  </div>
  <div id="tamborim" class="track">
    <input type="checkbox" id="toggle-tamborim" checked>
    <label for="toggle-tamborim">Tamborim</label>
  </div>
  <div id="caisse" class="track">
    <input type="checkbox" id="toggle-caisse" checked>
    <label for="toggle-caisse">Caisse</label>
  </div>
  <div id="repique" class="track">
    <input type="checkbox" id="toggle-repique" checked>
    <label for="toggle-repique">Repique</label>
  </div>
  <div id="surdo12" class="track">
    <input type="checkbox" id="toggle-surdo12" checked>
    <label for="toggle-surdo12">Surdo12</label>
  </div>
  <div id="surdo3" class="track">
    <input type="checkbox" id="toggle-surdo3" checked>
    <label for="toggle-surdo3">Surdo3</label>
  </div>
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <script type="text/javascript">
  let playing = false
  let speedInput = document.getElementById("speedInput")
  let instruments = document.getElementsByClassName("track")
  const surfers = new Map()

  // init waveforms
  for (let i = 0; i < instruments.length; i++) {
    let instrument = instruments[i].id
    let wavesurfer = WaveSurfer.create(
    {
      container: '#'+instrument,
      waveColor: 'violet',
      progressColor: 'purple',
      responsive: true,
      skipLength: 0.5
    });
    wavesurfer.load(instrument+'.mp3');
    wavesurfer.on('seek', function (progress) { seekTo(progress) })
    surfers.set(instrument, wavesurfer)
  }

  function play() {
    surfers.forEach(function (surfer, instrument) {
      if(document.getElementById("toggle-"+instrument).checked)
      {
        surfer.play()
      }
    })
    document.getElementById("playButton").innerHTML = "Pause"
    playing = true
  }

  function pause() {
    surfers.forEach( function(surfer) { surfer.pause() })
    document.getElementById("playButton").innerHTML = "Play"
    playing = false
  }

  function playPause() {
    if( !playing ) {
      play()
    }
    else {
      pause()
    }
  }

  function seekTo(progress) {
    surfers.forEach(function(surfer) {
      let currentProgress = surfer.getCurrentTime()/surfer.getDuration()
      if(Math.abs(currentProgress-progress) > 0.01) { // avoid recursive events
        surfer.seekTo(progress)
      }
    })
  }

  function stop() {
    pause()
    seekTo(0)
  }

  function skipBackward() {
    surfers.forEach(function(surfer){surfer.skipBackward()})
  }

  function skipForward() {
    surfers.forEach(function(surfer){surfer.skipForward()})
  }

  function setSpeed(speed) {
    console.log(speed)
    surfers.forEach(function(surfer){surfer.setPlaybackRate(speed)})
  }

  function accelerate() {
    let speed = Number(speedInput.value)
    speedInput.value = speed + 0.1
    speedInput.dispatchEvent(new Event('change'))
  }

  function slowdown() {
    let speed = Number(speedInput.value)
    speedInput.value = speed - 0.1
    speedInput.dispatchEvent(new Event('change'))
  }

  function handleKeypress(e) {
    switch(e.which) {
      case 32: // space
        playPause()
        e.preventDefault()
        break
      case 39: // right arrow
        skipForward()
        e.preventDefault()
        break
      case 37: // left arrow
        skipBackward()
        e.preventDefault()
        break
      case 38: // up arrow
        accelerate()
        e.preventDefault()
        break
      case 40: // down arrow
        slowdown()
        e.preventDefault()
        break
    }
  }

  document.addEventListener("keydown", handleKeypress);

  </script>
</body>
</html>