<!DOCTYPE html>
<html>
<head>
  <title>Jukebox Yolande</title>
</head>
<body>
  <h1>Jukebox Yolande : Pilou pilou</h1>

  <button onclick="stop()">Stop</button>
  <button onclick="skipBackward()"><<</button>
  <button id="playButton" onclick="playPause()">Play</button>
  <button onclick="skipForward()">>></button>

  <label for="speed">Speed :</label>
  <input type="range" id="speedInput" name="speed" min="0.5" max="1.5" step="0.1" value="1" onchange="setSpeed(this.value)">

  <div class="track" id="mestre">
    <div class="avatar">
      <img src="../logo.png" alt="mestre" description="mestre" onclick="toggleMute('mestre')" width="80px" height="80px">
    </div>
    <div class="surfer" id="mestre-surfer">
    </div>
  </div>

  <div class="track" id="tamborim">
    <div class="avatar">
      <img src="../logo.png" alt="tamborim" description="tamborim" onclick="toggleMute('tamborim')" width="80px" height="80px">
    </div>
    <div class="surfer" id="tamborim-surfer">
    </div>
  </div>

  <div class="track" id="caisse">
    <div class="avatar">
      <img src="../logo.png" alt="caisse" description="caisse" onclick="toggleMute('caisse')" width="80px" height="80px">
    </div>
    <div class="surfer" id="caisse-surfer">
    </div>
  </div>

  <div class="track" id="repique">
    <div class="avatar">
      <img src="../logo.png" alt="repique" description="repique" onclick="toggleMute('repique')" width="80px" height="80px">
    </div>
    <div class="surfer" id="repique-surfer">
    </div>
  </div>

  <div class="track" id="surdo12">
    <div class="avatar">
      <img src="../logo.png" alt="surdo12" description="surdo12" onclick="toggleMute('surdo12')" width="80px" height="80px">
    </div>
    <div class="surfer" id="surdo12-surfer">
    </div>
  </div>

  <div class="track" id="surdo3">
    <div class="avatar">
      <img src="../logo.png" alt="surdo3" description="surdo3" onclick="toggleMute('surdo3')" width="80px" height="80px">
    </div>
    <div class="surfer" id="surdo3-surfer">
    </div>
  </div>

  <style type="text/css">
    body {
      width: 60%;
      margin-left: auto;
      margin-right: auto;
    }
    .avatar {
      display: inline-block;
      vertical-align: middle;
    }
    .muted {
      filter: grayscale(100%);
    }
    .surfer {
      display: inline-block;
      vertical-align: middle;
      width:90%;
    }
  </style>
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <script type="text/javascript">
  let playing = false
  let speedInput = document.getElementById("speedInput")
  let instruments = document.getElementsByClassName("track")
  const surfers = new Map()

  // init waveforms
  for (let i = 0; i < instruments.length; i++) {
    let instrument = instruments[i].id
    let wavesurfer = WaveSurfer.create(
    {
      container: '#'+instrument+"-surfer",
      waveColor: 'violet',
      progressColor: 'purple',
      responsive: true,
      skipLength: 0.5
    });
    wavesurfer.load(instrument+'.mp3');
    wavesurfer.on('seek', function (progress) { seekTo(progress) })
    surfers.set(instrument, wavesurfer)
  }

  function play() {
    surfers.forEach(function (surfer, instrument) {
      //if(document.getElementById("toggle-"+instrument).checked)
      {
        surfer.play()
      }
    })
    document.getElementById("playButton").innerHTML = "Pause"
    playing = true
  }

  function pause() {
    surfers.forEach( function(surfer) { surfer.pause() })
    document.getElementById("playButton").innerHTML = "Play"
    playing = false
  }

  function playPause() {
    if( !playing ) {
      play()
    }
    else {
      pause()
    }
  }

  function seekTo(progress) {
    surfers.forEach(function(surfer) {
      let currentProgress = surfer.getCurrentTime()/surfer.getDuration()
      if(Math.abs(currentProgress-progress) > 0.01) { // avoid recursive events
        surfer.seekTo(progress)
      }
    })
  }

  function stop() {
    pause()
    seekTo(0)
  }

  function skipBackward() {
    surfers.forEach(function(surfer){surfer.skipBackward()})
  }

  function skipForward() {
    surfers.forEach(function(surfer){surfer.skipForward()})
  }

  function setSpeed(speed) {
    console.log(speed)
    surfers.forEach(function(surfer){surfer.setPlaybackRate(speed)})
  }

  function accelerate() {
    let speed = Number(speedInput.value)
    speedInput.value = speed + 0.1
    speedInput.dispatchEvent(new Event('change'))
  }

  function slowdown() {
    let speed = Number(speedInput.value)
    speedInput.value = speed - 0.1
    speedInput.dispatchEvent(new Event('change'))
  }

  function toggleMute(instrument) {
    let surfer = surfers.get(instrument)
    surfer.toggleMute()
    if(surfer.getMute()) {
      document.getElementById(instrument).classList.add("muted")
    } else {
      document.getElementById(instrument).classList.remove("muted")
    }
  }

  function handleKeypress(e) {
    switch(e.which) {
      case 32: // space
        playPause()
        e.preventDefault()
        break
      case 39: // right arrow
        skipForward()
        e.preventDefault()
        break
      case 37: // left arrow
        skipBackward()
        e.preventDefault()
        break
      case 38: // up arrow
        accelerate()
        e.preventDefault()
        break
      case 40: // down arrow
        slowdown()
        e.preventDefault()
        break
    }
  }

  document.addEventListener("keydown", handleKeypress);

  </script>
</body>
</html>