<!DOCTYPE html>
<html>
<head>
  <title>Jukebox Yolande - Pilou pilou</title>
  <meta charset="UTF-8">
</head>
<body>
  <div id="content">
    <h1><img src="../yolande.png" height="80px">Pilou pilou</h1>

    <div id="controls">
      <button onclick="stop()">‚ñ†</button>
      <button onclick="skipBackward()">‚èÆ</button>
      <button id="playButton" onclick="playPause()">‚ñ∂</button>
      <button onclick="skipForward()">‚è≠</button>

      <span id="speedControls">
        <span class="emoji">üê¢</span>
        <input type="range" id="speedInput" name="speed" min="0.5" max="1.5" step="0.1" value="1" onchange="setSpeed(this.value)">
        <span class="emoji">üêá</span>
      </span>
    </div>

    <div id="tracks">
      <div class="track" id="mestre">
        <div class="avatar">
          <img src="../mestre.png" alt="mestre" description="mestre" onclick="toggleMute('mestre')" width="80px" height="80px">
        </div>
        <div class="player" id="mestre-player">
        </div>
      </div>

      <div class="track" id="tamborim">
        <div class="avatar">
          <img src="../tamborim.png" alt="tamborim" description="tamborim" onclick="toggleMute('tamborim')" width="80px" height="80px">
        </div>
        <div class="player" id="tamborim-player">
        </div>
      </div>

      <div class="track" id="caisse">
        <div class="avatar">
          <img src="../caisse.png" alt="caisse" description="caisse" onclick="toggleMute('caisse')" width="80px" height="80px">
        </div>
        <div class="player" id="caisse-player">
        </div>
      </div>

      <div class="track" id="repique">
        <div class="avatar">
          <img src="../repique.png" alt="repique" description="repique" onclick="toggleMute('repique')" width="80px" height="80px">
        </div>
        <div class="player" id="repique-player">
        </div>
      </div>

      <div class="track" id="surdo1">
        <div class="avatar">
          <img src="../surdo1.png" alt="surdo1" description="surdo1" onclick="toggleMute('surdo1')" width="80px" height="80px">
        </div>
        <div class="player" id="surdo1-player">
        </div>
      </div>

      <div class="track" id="surdo2">
        <div class="avatar">
          <img src="../surdo2.png" alt="surdo2" description="surdo2" onclick="toggleMute('surdo2')" width="80px" height="80px">
        </div>
        <div class="player" id="surdo2-player">
        </div>
      </div>

      <div class="track" id="surdo3">
        <div class="avatar">
          <img src="../surdo3.png" alt="surdo3" description="surdo3" onclick="toggleMute('surdo3')" width="80px" height="80px">
        </div>
        <div class="player" id="surdo3-player">
        </div>
      </div>

    </div>
  </div>

  <style type="text/css">
    body {
      background: #D23789;
      background-image: url("../zebra.svg");
      background-size: cover;
    }
    #content {
      width: 60%;
      margin-left: auto;
      margin-right: auto;
      background: white;
      padding: 20px;
    }
    h1 {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #controls {
      display: flex;
      justify-content: center;
    }
    #speedControls {
      margin-left: 40px;
    }
    .emoji {
      font-size: 30px;
    }
    .avatar {
      display: inline-block;
      vertical-align: middle;
    }
    .muted {
      filter: opacity(50%);
    }
    .player {
      display: inline-block;
      vertical-align: middle;
      width:90%;
    }
  </style>
  <script src="../wavesurfer.js"></script>
  <script type="text/javascript">
  let playing = false
  const speedInput = document.getElementById("speedInput")
  const players = new Map()

  fetch("tracks.json")
    .then(response => response.json())
    .then(tracks => init(tracks));

  function init(tracks) {
    // init audio players
    for (let i = 0; i < tracks.length; i++) {
      let track = tracks[i]["id"]
      let player = WaveSurfer.create(
      {
        container: '#'+track+"-player",
        height: 80,
        waveColor: 'purple',
        progressColor: 'fuchsia',
        responsive: true,
        skipLength: 0.5
      });
      player.load(tracks[i]["audio"]);
      player.on('seek', function (progress) { seekTo(progress) })
      players.set(track, player)
    }
  }

  function play() {
    players.forEach(function (player, instrument) { player.play() })
    document.getElementById("playButton").innerHTML = "‚è∏"
    playing = true
  }

  function pause() {
    players.forEach( function(player) { player.pause() })
    document.getElementById("playButton").innerHTML = "‚ñ∂"
    playing = false
  }

  function playPause() {
    if( !playing ) {
      play()
    }
    else {
      pause()
    }
  }

  function seekTo(progress) {
    players.forEach(function(player) {
      let currentProgress = player.getCurrentTime()/player.getDuration()
      if(Math.abs(currentProgress-progress) > 0.01) { // avoid recursive events
        player.seekTo(progress)
      }
    })
  }

  function stop() {
    pause()
    seekTo(0)
  }

  function skipBackward() {
    players.forEach(function(player){player.skipBackward()})
  }

  function skipForward() {
    players.forEach(function(player){player.skipForward()})
  }

  function setSpeed(speed) {
    players.forEach(function(player){player.setPlaybackRate(speed)})
  }

  function accelerate() {
    let speed = Number(speedInput.value)
    speedInput.value = speed + 0.1
    speedInput.dispatchEvent(new Event('change'))
  }

  function slowdown() {
    let speed = Number(speedInput.value)
    speedInput.value = speed - 0.1
    speedInput.dispatchEvent(new Event('change'))
  }

  function toggleMute(instrument) {
    let player = players.get(instrument)
    player.toggleMute()
    if(player.getMute()) {
      document.getElementById(instrument).classList.add("muted")
    } else {
      document.getElementById(instrument).classList.remove("muted")
    }
  }

  function handleKeypress(e) {
    switch(e.which) {
      case 32: // space
        playPause()
        e.preventDefault()
        break
      case 39: // right arrow
        skipForward()
        e.preventDefault()
        break
      case 37: // left arrow
        skipBackward()
        e.preventDefault()
        break
      case 38: // up arrow
        accelerate()
        e.preventDefault()
        break
      case 40: // down arrow
        slowdown()
        e.preventDefault()
        break
    }
  }

  document.addEventListener("keydown", handleKeypress);

  </script>
</body>
</html>